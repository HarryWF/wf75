<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <link rel="stylesheet" href="/static/style.css" />

    <script>
      var PREV_SPHERE = null;
      var CUR_SPHERE = null;

      function wrapAngleDeg(angle) {
        if (angle < 0) {
          return angle + 360;
        }

        if (angle > 360) {
          return angle - 360;
        }

        return angle;
      }

      AFRAME.registerComponent('edges', {
        addedEdges: false,
        tick: function(time, timeDelta) {
          let mesh = this.el.getObject3D("mesh");

          if (mesh === undefined || this.addedEdges) {
            return;
          }

          let arrow_obj = mesh.children[0];
          let edges_geom = new THREE.EdgesGeometry(arrow_obj.geometry);
          let line = new THREE.LineSegments(edges_geom, new THREE.LineBasicMaterial({ color: 0x000000 }));

          arrow_obj.add(line);
          this.addedEdges = true;
        }
      });

      AFRAME.registerComponent('zoomable', {
        zoomRate: 0.2,
        init: function () {
          document.body.addEventListener('wheel', this.handleZoom.bind(this));
        },

        handleZoom: function(ev) {
          const delta = Math.sign(event.wheelDelta) * this.zoomRate;

          let zoom = Number(this.el.getAttribute('zoom'));
          let newZoom = zoom + delta;
          if (newZoom <= 1) {
            newZoom = zoom;
          }
          if (newZoom > 5) {
            newZoom = zoom;
          }
          this.el.setAttribute('zoom', newZoom);
        }
      });

      AFRAME.registerComponent('measure-angle', {
        init: function() {
          this.el.addEventListener('raycaster-intersected', evt => {
            this.raycaster = evt.detail.el;
          });
          this.el.addEventListener('raycaster-intersected-cleared', evt => {
            this.raycaster = null;
          });
        },

        tick: function(t, td) {
          if (!this.raycaster) { return; }  // Not intersecting.

          let intersection = this.raycaster.components.raycaster.getIntersection(this.el);
          if (!intersection) { return; }

          let point = intersection.point;
          let angle = (Math.atan2(-point.z, -point.x) - (Math.PI / 2)) * 180 / Math.PI;
          if (angle < 0) { angle = 360 + angle; }

          angle = angle.toFixed(1);

          $("#angle").text(`Angle: ${angle}`);
        }
      });

      AFRAME.registerComponent('sphere-rotation', {
        schema: {
          angle: {type: 'int', default: 0},
        },
        dependencies: ["look-controls"],
        init: function() {
        },
        update: function() {
          let camera = document.getElementById("camera");
          let controls = camera.components["look-controls"];
          let angleRad = (360 - this.data.angle) * Math.PI / 180;
          console.log(`Setting rotation to ${angleRad}`)
          controls.yawObject.rotation.set(0, angleRad, 0);
          controls.magicWindowDeltaEuler.set(0, 0, 0);
        }
      });

      $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results) {
          return results[1] || null;
        } else {
          return null;
        }
      }

      jQuery.fn.exists = function(){return this.length>0;}

      function draw_arrows(sphere_data) {
        for (const n_data of sphere_data["neighbours"]) {
          try {
            $("a-scene").append(`<a-entity gltf-model="#arrow" id="ar${n_data["id"]}" class="clickable arrow" mixin="bounce" position="${n_data["coordinates"]["x"]} 0.5 ${n_data["coordinates"]["y"]}" rotation="0 -${n_data["angle"]} 0" edges></a-entity>`);
          } catch (e) {
            console.log(e)
          }
        }

        $(".arrow").on("click", function(e) {
          let target_id = e.target.id.slice(2);
          set_sphere(target_id);

          var url = new URL(window.location);
          url.searchParams.set("id", target_id);
          window.history.pushState(null, document.title, url.href);
        });
      }

      function clear_arrows() {
        $(".arrow").remove();
      }

      function append_sphere_asset(id) {
        if (!$(`#sp${id}`).exists()) {
          $("#assets").append(`<img id="sp${id}" crossorigin="anonymous" src="/static/spheres/${id}.jpg">`);
        }
      }

      function set_sphere(id) {
        PREV_SPHERE = CUR_SPHERE;
        CUR_SPHERE = id;

        append_sphere_asset(id);

        $.ajax({url: `../api/sphere_data/${id}`, success: function(sphere_data){
          clear_arrows();
          draw_arrows(sphere_data);

          if (PREV_SPHERE) {
            let angleToNeighbour = sphere_data["neighbours"].filter((n) => n["id"] == PREV_SPHERE)[0]["angle"];
            let angleFromNeighbour = wrapAngleDeg(angleToNeighbour - 180);
            $("#camera")[0].setAttribute('sphere-rotation', {angle: angleFromNeighbour});
          } else if ($.urlParam("angle")) {
            console.log($.urlParam("angle"));
            $("#camera")[0].setAttribute('sphere-rotation', {angle: $.urlParam("angle")});
          }

          $("#sky").attr("src", `#sp${id}`);

          for (const n_data of sphere_data["neighbours"]) {
            append_sphere_asset(n_data["id"]);
          }
        }});

      }

      window.addEventListener('popstate', function() {
        set_sphere($.urlParam("id"));
      });
    </script>
  </head>
  <body>
    <a-scene cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .clickable">
      <a-assets id="assets">
        <img id="" class="sp" crossorigin="anonymous" src="">
        <img id="logo" crossorigin="anonymous" src="/static/logo.png">
        <a-asset-item id="arrow" src="/static/arrow.glb"></a-asset-item>
        <a-mixin id="bounce" scale="0.1 0.1 0.1" animation__scale="property: scale; to: 0.12 0.12 0.12; dur: 100; startEvents: mouseenter" animation__scale_reverse="property: scale; to: 0.1 0.1 0.1; dur: 100; startEvents: mouseleave"></a-mixin>
      </a-assets>
      <a-sky id="sky" class="clickable" src="#sp" measure-angle></a-sky>
      <a-circle color="#FFF" radius="0.60" rotation="-90 0 0"></a-circle>

      <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: [gui-interactable]"></a-entity>
		  <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: [gui-interactable]"></a-entity>
		  <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: [gui-interactable]"></a-entity>
      
      <a-camera sphere-rotation="angle: 0" id="camera" zoomable zoom=1 wasd-controls-enabled="false" look-controls="reverseMouseDrag: true"></a-camera>


      <a-light type="ambient"></a-light>
      <a-light type="point" intensity="2" position="0 5 0"></a-light>
    </a-scene>
    <div id="angle"></div>

    <script>
      window.onload = function() {
        if ($.urlParam("id")) {
          set_sphere($.urlParam("id"));
        } else {
          set_sphere("0209");
        }
      }
    </script>
  </body>
</html>
