<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <script>
      var PREV_SPHERE = null;
      var CUR_SPHERE = null;

      $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results) {
          return results[1] || 0;
        } else {
          return 0
        }
      }

      jQuery.fn.exists = function(){return this.length>0;}

      function draw_arrows(sphere_data) {
        for (const n_data of sphere_data["neighbours"]) {
          $("a-scene").append(`<a-entity gltf-model="#arrow" id="ar${n_data["id"]}" class="arrow" mixin="bounce" position="${n_data["coordinates"]["x"]} 0.5 ${n_data["coordinates"]["y"]}" rotation="0 -${n_data["angle"]} 0"></a-entity>`)
        }

        $(".arrow").on("click", function(e) {
          let target_id = e.target.id.slice(2);
          set_sphere(target_id);

          var url = new URL(window.location);
          url.searchParams.set("id", target_id);
          window.history.pushState(null, document.title, url.href);
        });
      }

      function clear_arrows() {
        $(".arrow").remove();
      }

      function set_cam_rotation(sphere_data) {
        if (PREV_SPHERE){
          const angle = sphere_data["neighbours"].filter((n) => n["id"] == PREV_SPHERE)[0]["angle"];
          console.log(angle);

          let controls = document.querySelector('a-camera').components['look-controls'];
          controls.pitchObject.rotation.x = 0;
          controls.yawObject.rotation.y = 0;
          $("#cameraWrapper")[0].object3D.rotation.set(0, (180-angle)*(Math.PI/180), 0);
        }
      }

      function append_sphere_asset(id) {
        if (!$(`#sp${id}`).exists()) {
          console.log(id);
          $("#assets").append(`<img id="sp${id}" crossorigin="anonymous" src="/static/spheres/${id}.jpg">`);
        }
      }

      function set_sphere(id) {
        PREV_SPHERE = CUR_SPHERE;
        CUR_SPHERE = id;

        append_sphere_asset(id);

        $.ajax({url: `../api/sphere_data/${id}`, success: function(sphere_data){
          clear_arrows();
          draw_arrows(sphere_data);
          set_cam_rotation(sphere_data);

          for (const n_data of sphere_data["neighbours"]) {
            append_sphere_asset(n_data["id"]);
          }
        }});

        $("#sky").attr("src", `#sp${id}`);
      }

      window.addEventListener('popstate', function() {
        set_sphere($.urlParam("id"));
      });
    </script>
  </head>
  <body>
    <a-scene cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .arrow">
      <a-assets id="assets">
        <img id="" class="sp" crossorigin="anonymous" src="">
        <a-asset-item id="arrow" src="/static/arrow.glb"></a-asset-item>
        <a-mixin id="bounce" scale="0.1 0.1 0.1" animation__scale="property: scale; to: 0.12 0.12 0.12; dur: 100; startEvents: mouseenter" animation__scale_reverse="property: scale; to: 0.1 0.1 0.1; dur: 100; startEvents: mouseleave"></a-mixin>
      </a-assets>
      <a-sky id="sky" src="#sp" rotation="0 90 0"></a-sky>
      
      <a-entity id='cameraWrapper'>
        <a-camera wasd-controls-enabled="false" look-controls="reverseMouseDrag: true"></a-camera>
      </a-entity>


      <a-light type="ambient"></a-light>
      <a-light type="point" intensity="2" position="0 5 0"></a-light>
    </a-scene>

    <script>
      if ($.urlParam("id") != 0) {
        set_sphere($.urlParam("id"));
      } else {
        set_sphere("0209");
      }
      
    </script>
  </body>
</html>